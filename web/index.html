<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <link href="https://cdn.bootcss.com/bootstrap/4.0.0-beta.2/css/bootstrap.css" rel="stylesheet">
  <link href="https://cdn.bootcss.com/sco.js/1.1.0/css/scojs.css" rel="stylesheet">
  <link href="https://cdn.bootcss.com/material-design-icons/3.0.1/iconfont/material-icons.css" rel="stylesheet">
  <link href="./index.css" rel="stylesheet">
  <script src="https://cdn.bootcss.com/jquery/3.2.1/jquery.js"></script>
  <script src="https://cdn.bootcss.com/bootstrap/4.0.0-beta.2/js/bootstrap.bundle.js"></script>
  <script src="https://cdn.bootcss.com/sco.js/1.1.0/js/sco.message.js"></script>
  <title>聊天室</title>
</head>

<body>
  <div class="container">
    <div class="talk-List row">

    </div>
    <div class="row">
      <div class="col-sm-9 form-group">
        <label>发送的内容：</label>
        <textarea class="form-control" id="send-content" rows="5"></textarea>
      </div>
      <div class="col-sm-3 form-group">
          <button type="button" id="send" class="btn btn-primary">
            <i class="material-icons md-48">send</i>
          </button>
        </div>
    </div>
  </div>
  <div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="exampleModalLabel">登录</h5>
        </div>
        <div class="modal-body">
          <form>
            <div class="form-group">
              <label for="recipient-user" class="col-form-label">昵称:</label>
              <input type="text" class="form-control" id="recipient-user">
            </div>
            <div class="form-group">
              <label for="message-text" class="col-form-label">email:</label>
              <input type="text" class="form-control" id="recipient-email">
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" id="login" class="btn btn-primary">登录</button>
        </div>
      </div>
    </div>
  </div>
</body>
<script>
  $(function () {
    // 检查session是否登录
    $.get('/session',function(data){
      if(data.code==401){
        return
      }
      $('#exampleModal').modal('show')
    })
    // 登录
    $('#login').on('click',function(){
      let user = $('#recipient-user').val()
      let email = $('#recipient-email').val()
      $.post('/login',{user,email},function(data){
        if(data.code == 200){
          $('#exampleModal').modal('hide')
          $.scojs_message('登录成功，请开始你的表演',$.scojs_message.TYPE_OK)
          startWs()
          return;
        }
        $.scojs_message(data.msg,$.scojs_message.TYPE_ERROR)
      })
    })
  })
  function startWs(){
    const websocket = new WebSocket(`ws://${window.location.host}`)
    websocket.addEventListener('open', event => {
      $('#send').on('click', () => {
        let content = $('#send-content').val();
        websocket.send(content)
      })
    })
    websocket.addEventListener('message', event => {
      $('#res-content').val(event.data)
    })
  }
</script>

</html>